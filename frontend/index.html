<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cognify - Level 1 (Semantic)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Simple loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Star Rating */
        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: center;
        }
        .star-rating input[type="radio"] { display: none; }
        .star-rating label {
            font-size: 2.5rem;
            color: #4a5568;
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-rating input[type="radio"]:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #f59e0b; /* amber-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen py-12">

    <div class="max-w-2xl w-full p-8 bg-gray-800 rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold text-center mb-2">Cognify ðŸ§ </h1>
        <p class="text-center text-gray-400 mb-6">Level 1: Semantic & Crowd Analysis</p>

        <form id="ideaForm" class="space-y-4">
            <div>
                <label for="ideaText" class="block text-sm font-medium text-gray-300 mb-1">Your Idea (Max 280 chars):</label>
                <textarea id="ideaText" name="ideaText" rows="4" maxlength="280"
                          class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                          placeholder="What's your new idea? e.g., 'A fork that vibrates if you eat too fast'"></textarea>
                <div class="text-right text-sm text-gray-500">
                    <span id="charCount">0</span> / 280
                </div>
            </div>

            <!-- This block will show the search results -->
            <div id="similarContainer" class="hidden">
                <h4 class="text-sm font-semibold text-amber-400">Similar Ideas Found:</h4>
                <div id="similarSpinner" class="spinner h-5 w-5 my-2 hidden"></div>
                <div id="similarResults" class="space-y-2"></div>
            </div>

            <!-- Button 1: Search -->
            <button type="button" id="searchButton"
                    class="w-full flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 ease-in-out">
                <span id="searchButtonText">Check for Similar Ideas</span>
                <div id="searchSpinner" class="spinner hidden ml-2"></div>
            </button>
            
            <!-- Button 2: Submit (hidden by default) -->
            <button type="button" id="submitButton"
                    class="w-full flex items-center justify-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 ease-in-out hidden">
                <span id="submitButtonText">Submit as Unique Idea</span>
                <div id="submitSpinner" class="spinner hidden ml-2"></div>
            </button>
        </form>

        <!-- Final Result (from submit) -->
        <div id="resultContainer" class="mt-6 hidden space-y-6">
            <div id="resultOutput"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // As you requested, using your localhost URLs.
        const SUBMIT_URL = "http://localhost:5678/webhook/cognify-v0"; 
        const SEARCH_URL = "http://localhost:5678/webhook/cognify-search";
        const RATING_URL = "http://localhost:5678/webhook/cognify-rate";
        const SIMILARITY_THRESHOLD = 0.85; // Block if score is > 0.85

        // --- STATE ---
        let currentProofId = null;
        let topSimilarityScore = 0.0;

        // --- ELEMENTS ---
        const ideaText = document.getElementById('ideaText');
        const charCount = document.getElementById('charCount');
        const resultContainer = document.getElementById('resultContainer');
        const resultOutput = document.getElementById('resultOutput');
        
        const searchButton = document.getElementById('searchButton');
        const searchButtonText = document.getElementById('searchButtonText');
        const searchSpinner = document.getElementById('searchSpinner');
        
        const submitButton = document.getElementById('submitButton');
        const submitButtonText = document.getElementById('submitButtonText');
        const submitSpinner = document.getElementById('submitSpinner');
        
        const similarContainer = document.getElementById('similarContainer');
        const similarSpinner = document.getElementById('similarSpinner');
        const similarResults = document.getElementById('similarResults');

        // --- EVENT LISTENERS ---
        
        // Character counter
        ideaText.addEventListener('input', () => {
            charCount.textContent = ideaText.value.length;
            // Reset state if user types again
            similarContainer.classList.add('hidden');
            resultContainer.classList.add('hidden');
            submitButton.classList.add('hidden');
            searchButton.disabled = false;
            searchButton.classList.remove('bg-gray-500', 'hover:bg-gray-500');
            searchButtonText.textContent = 'Check for Similar Ideas';
        });

        // Search Button click listener
        searchButton.addEventListener('click', handleSearch);

        // Submit Button click listener
        submitButton.addEventListener('click', handleSubmit);
        
        
        // --- SEARCH LOGIC (for Button 1) ---
        async function handleSearch() {
            const text = ideaText.value.trim();
            if (text.length < 5) {
                alert("Please enter a more detailed idea (at least 5 characters).");
                return;
            }

            // Start search loading
            searchButton.disabled = true;
            searchSpinner.classList.remove('hidden');
            searchButtonText.textContent = 'Searching...';
            similarContainer.classList.remove('hidden'); 
            similarSpinner.classList.remove('hidden'); 
            resultContainer.classList.add('hidden'); 
            submitButton.classList.add('hidden'); 

            try {
                const response = await fetch(SEARCH_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                if (!response.ok) throw new Error('Search request failed');
                
                const results = await response.json();
                displaySimilar(results);

            } catch (error) {
                console.error('Search error:', error);
                similarResults.innerHTML = `<p class="text-red-400">Error: ${error.message}. Is your n8n server running? Is your CORS extension on?</p>`;
            } finally {
                // Stop search loading
                searchButton.disabled = false;
                searchSpinner.classList.add('hidden');
                searchButtonText.textContent = 'Check for Similar Ideas';
                similarSpinner.classList.add('hidden');
            }
        }

        function displaySimilar(results) {
            similarResults.innerHTML = '';
            if (results.length === 0) {
                topSimilarityScore = 0.0;
            } else {
                topSimilarityScore = results[0].score || 0.0;
            }
            
            // Check threshold and decide what to do
            if (topSimilarityScore > SIMILARITY_THRESHOLD) {
                searchButton.disabled = true;
                searchButton.classList.add('bg-gray-500', 'hover:bg-gray-500');
                searchButtonText.textContent = 'Idea is Too Similar';
                submitButton.classList.add('hidden'); // Keep submit button hidden
            } else {
                searchButton.disabled = false;
                searchButtonText.textContent = 'Check Again';
                submitButton.classList.remove('hidden'); // Show the "Submit" button
            }

            // Display results
            results.forEach(item => {
                const scorePercent = (item.score * 100).toFixed(0);
                
                // Read from item.document.metadata
                const metadata = item.document.metadata; 
                if (!metadata) return; // Skip if metadata is missing

                const el = document.createElement('div');
                el.className = 'p-2 bg-gray-700 rounded';
                el.innerHTML = `
                    <p class="text-sm">
                        <span class="font-bold text-amber-300">${scorePercent}% Match:</span>
                        <!-- Read from metadata.raw_text -->
                        ${metadata.raw_text}
                    </p>
                `;
                similarResults.appendChild(el);
            });
            similarContainer.classList.remove('hidden');
        }

        // --- SUBMIT LOGIC (for Button 2) ---
        async function handleSubmit() {
            const text = ideaText.value.trim();
            if (text === '') return;
            
            setSubmitLoading(true); // Use the new setLoading function
            currentProofId = null;

            try {
                const response = await fetch(SUBMIT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });

                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const result = await response.json();
                
                currentProofId = result.proof_id;
                displayResult(result); // This is the full AI analysis

            } catch (error) {
                console.error('Error submitting idea:', error);
                displayResult({ error: error.message });
            } finally {
                setSubmitLoading(false);
            }
        }

        // --- RATING & DISPLAY ---
        async function submitRating(rating) {
            if (!currentProofId) { alert('Could not find a proof_id to rate.'); return; }
            const ratingElement = document.getElementById('ratingSection');
            ratingElement.innerHTML = `<p class="text-center text-amber-500">Submitting your ${rating}-star rating...</p>`;
            try {
                await fetch(RATING_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idea_id: currentProofId, rating: rating })
                });
                setTimeout(() => {
                    ratingElement.innerHTML = `<p class="text-center text-green-400 font-bold">Thank you for your rating!</p>`;
                }, 1000);
            } catch (error) {
                ratingElement.innerHTML = `<p class="text-center text-red-400">Error: ${error.message}</p>`;
            }
        }

        // Modified Loading function for SUBMIT button
        function setSubmitLoading(isLoading) {
            submitButton.disabled = isLoading;
            submitSpinner.classList.toggle('hidden', !isLoading);
            submitButtonText.textContent = isLoading ? 'Analyzing...' : 'Submit as Unique Idea';
            
            // Also disable search button during final analysis
            searchButton.disabled = isLoading;

            if(isLoading) {
                resultContainer.classList.add('hidden'); // Hide old results
            }
        }

        function displayResult(data) {
            resultOutput.innerHTML = '';
            
            // This handles the n8n wrapper { "frontend_response": {...} }
            const fr = data.frontend_response || data;

            if (fr.error) {
                resultOutput.innerHTML = `<h2 class="text-2xl font-semibold text-red-400">Error</h2><p>${fr.error}</p>`;
                resultContainer.classList.remove('hidden');
                return;
            }
            
            if (!fr.verdict) {
                console.error("Invalid data structure received:", data);
                resultOutput.innerHTML = `<h2 class="text-2xl font-semibold text-red-400">Error</h2><p>Received an invalid response from the server.</p>`;
                resultContainer.classList.remove('hidden');
                return;
            }

            currentProofId = fr.proof_id;

            let html = '';
            if (fr.verdict === 'UNIQUE') {
                html += `<h2 class="text-2xl font-semibold text-green-400">Verdict: ${fr.verdict}</h2>`;
            } else {
                html += `<h2 class="text-2xl font-semibold text-amber-400">Verdict: ${fr.verdict}</h2>`;
                if(fr.components?.ai_analysis?.note) {
                    html += `<p class="text-sm text-gray-400">${fr.components.ai_analysis.note}</p>`;
                }
            }
            html += `<p class="text-xs font-mono text-gray-500">Proof ID: ${fr.proof_id}</p>`;
            
            const ai = fr.components?.ai_analysis;
            if(ai) {
                html += '<div class="border-t border-gray-700 pt-4 mt-4">';
                html += `<h3 class="text-xl font-semibold mb-3">Cognitive Analysis</h3>`;
                const ambiguity = (ai.ambiguity_index || 0) * 100;
                html += `<div><label class="text-sm font-medium">Ambiguity Index</label><div class="w-full bg-gray-700 rounded-full h-2.5"><div class="bg-indigo-500 h-2.5 rounded-full" style="width: ${ambiguity}%"></div></div><p class="text-xs text-gray-400">${ai.ambiguity_index} (0.0 = Specific, 1.0 = Abstract)</p></div>`;
                html += `<p class="mt-3"><strong class="text-gray-300">Summary:</strong> ${ai.summary}</p>`;
                if (ai.interpretations && ai.interpretations.length > 0) {
                    html += '<h4 class="text-md font-semibold mt-4 mb-2">Possible Interpretations:</h4>';
                    html += '<ul class="list-disc list-inside space-y-1">';
                    ai.interpretations.forEach(item => {
                        html += `<li><strong class="text-indigo-300">${item.theme}:</strong> ${item.interpretation}</li>`;
                    });
                    html += '</ul>';
                }
                html += '</div>';
            }
            html += `<div id="ratingSection" class="border-t border-gray-700 pt-4 mt-4"><h3 class="text-xl font-semibold text-center mb-2">Rate this Idea</h3><div class="star-rating"><input type="radio" id="star5" name="rating" value="5" onclick="submitRating(5)"><label for="star5" title="5 stars">â˜…</label><input type="radio" id="star4" name="rating" value="4" onclick="submitRating(4)"><label for="star4" title="4 stars">â˜…</label><input type="radio" id="star3" name="rating" value="3" onclick="submitRating(3)"><label for="star3" title="3 stars">â˜…</label><input type="radio" id="star2" name="rating" value="2" onclick="submitRating(2)"><label for="star2" title="2 stars">â˜…</label><input type="radio" id="star1" name="rating" value="1" onclick="submitRating(1)"><label for="star1" title="1 star">â˜…</label></div></div>`;
            resultOutput.innerHTML = html;
            resultContainer.classList.remove('hidden');
        }

    </script>
</body>
</html>