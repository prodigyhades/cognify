<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cognify - Level 1 (Semantic)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.15);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 22px; height: 22px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .rotate-90 { transform: rotate(90deg); }
        .collapsible-content {
            overflow: hidden; 
            max-height: 0;
            transition: max-height 0.35s ease-out, padding 0.25s ease;
        }
        .collapsible-open { 
            max-height: 800px; 
            padding-top: 12px; 
            padding-bottom: 12px; 
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen py-12">
    <div class="max-w-2xl w-full p-8 bg-gray-800 rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold text-center mb-2">Cognify ðŸ§ </h1>
        <p class="text-center text-gray-400 mb-6">Level 1: Semantic & Crowd Analysis</p>

        <form id="ideaForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">Your Idea (Max 280 chars):</label>
                <textarea id="ideaText" rows="4" maxlength="280"
                    class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                    placeholder="What's your new idea?"></textarea>
                <div class="text-right text-sm text-gray-500"><span id="charCount">0</span> / 280</div>
            </div>

            <div id="similarContainer" class="hidden transition-opacity duration-300">
                <h4 class="text-sm font-semibold text-amber-400 mb-2">Analysis Results:</h4>
                <div id="similarSpinner" class="spinner h-5 w-5 my-3 hidden mx-auto"></div>
                <div id="similarResults" class="space-y-3"></div>
            </div>

            <button type="button" id="searchButton"
                class="w-full flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">
                <span id="searchButtonText">Check for Similar Ideas</span>
                <div id="searchSpinner" class="spinner hidden ml-3"></div>
            </button>

            <button type="button" id="submitButton"
                class="w-full flex items-center justify-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 hidden">
                <span id="submitButtonText">Submit as Unique Idea</span>
                <div id="submitSpinner" class="spinner hidden ml-3"></div>
            </button>
        </form>

        <div id="resultContainer" class="mt-6 hidden space-y-6"><div id="resultOutput"></div></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    console.log("Cognify App Loaded");

    // --- CONFIGURATION ---
    const SUBMIT_URL = "http://localhost:5678/webhook/cognify-v0";
    const SEARCH_URL = "http://localhost:5678/webhook/cognify-search";
    
    const MAX_AMBIGUITY = 0.86;
    const MAX_SIMILARITY = 0.95;

    // --- ELEMENTS ---
    const ideaText = document.getElementById("ideaText");
    const charCount = document.getElementById("charCount");
    const similarContainer = document.getElementById("similarContainer");
    const similarResults = document.getElementById("similarResults");
    const searchButton = document.getElementById("searchButton");
    const searchSpinner = document.getElementById("searchSpinner");
    const submitButton = document.getElementById("submitButton");
    const resultContainer = document.getElementById("resultContainer");

    // --- LISTENERS ---
    ideaText.addEventListener("input", handleInput);
    searchButton.addEventListener("click", handleSearch);
    submitButton.addEventListener("click", handleSubmit);

    // --- FUNCTIONS ---

    function handleInput() {
        charCount.textContent = ideaText.value.length;
        
        // 1. Hide submit button (force re-check if text changes)
        submitButton.classList.add("hidden");
        
        // 2. Reset search button
        searchButton.disabled = false;
        document.getElementById("searchButtonText").innerText = "Check for Similar Ideas";
        
        // 3. Dim old results instead of hiding them completely
        if (!similarContainer.classList.contains("hidden")) {
            similarContainer.classList.add("opacity-50");
        }
        if (!resultContainer.classList.contains("hidden")) {
            resultContainer.classList.add("opacity-50");
        }
    }

    async function handleSearch() {
        console.log("Search Clicked");
        const text = ideaText.value.trim();
        if (text.length < 5) { alert("Please enter a more detailed idea."); return; }

        // Reset UI for search
        similarContainer.classList.remove("hidden", "opacity-50");
        resultContainer.classList.add("hidden"); 
        
        document.getElementById("similarSpinner").classList.remove("hidden");
        searchSpinner.classList.remove("hidden");
        searchButton.disabled = true;
        document.getElementById("searchButtonText").innerText = "Analyzing...";

        try {
            const res = await fetch(SEARCH_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text })
            });
            const data = await res.json();
            displayAnalysis(data);
        } catch (err) {
            console.error("Search Error:", err);
            similarResults.innerHTML = `<p class="text-red-400">Error: ${err.message}</p>`;
        } finally {
            searchSpinner.classList.add("hidden");
            document.getElementById("similarSpinner").classList.add("hidden");
            searchButton.disabled = false;
            document.getElementById("searchButtonText").innerText = "Check Again";
        }
    }

    function displayAnalysis(data) {
        similarResults.innerHTML = "";
        
        const matches = data.matches || [];
        const ambiguityData = data.ambiguity_analysis || { ambiguity_index: 1.0, reasoning: "Analysis failed" };
        const ambiguityScore = ambiguityData.ambiguity_index;
        
        let highestSim = 0;
        if (matches.length > 0 && matches[0].score) highestSim = matches[0].score;

        // Metrics Display
        const ambColor = ambiguityScore > MAX_AMBIGUITY ? "text-red-400" : "text-green-400";
        const simColor = highestSim > MAX_SIMILARITY ? "text-red-400" : "text-indigo-400";
        
        const statsHtml = `
            <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                <div class="bg-gray-700/50 p-3 rounded border border-gray-600">
                    <div class="text-gray-400">Ambiguity Score</div>
                    <div class="font-bold text-lg ${ambColor}">${ambiguityScore} <span class="text-xs text-gray-500">/ 1.0</span></div>
                </div>
                <div class="bg-gray-700/50 p-3 rounded border border-gray-600">
                    <div class="text-gray-400">Max Similarity</div>
                    <div class="font-bold text-lg ${simColor}">${(highestSim * 100).toFixed(0)}%</div>
                </div>
            </div>
        `;
        similarResults.insertAdjacentHTML('beforeend', statsHtml);

        // List Matches
        if (matches.length === 0) {
            similarResults.insertAdjacentHTML('beforeend', `<div class="p-3 bg-green-900/20 border border-green-600/30 rounded text-green-400 text-sm text-center">âœ¨ Unique! No similar ideas found.</div>`);
        } else {
            matches.forEach(item => {
                const meta = item.document?.metadata || { raw_text: "Unknown" };
                const score = Math.round(item.score * 100);
                const el = document.createElement("div");
                el.className = "p-3 bg-gray-700/60 border border-gray-600 rounded text-sm flex justify-between gap-4";
                el.innerHTML = `<span class="text-gray-300">${meta.raw_text}</span> <span class="font-mono text-indigo-300 font-bold">${score}%</span>`;
                similarResults.appendChild(el);
            });
        }

        // Logic: Should we show the submit button?
        if (ambiguityScore > MAX_AMBIGUITY) {
            const err = document.createElement("div");
            err.className = "mt-4 p-4 bg-red-900/40 border border-red-500 rounded text-red-200 text-sm";
            err.innerHTML = `<strong>â›” Submission Blocked: Too Ambiguous</strong><p class="mt-1 text-xs opacity-80">${ambiguityData.reasoning}</p>`;
            similarResults.appendChild(err);
            submitButton.classList.add("hidden");
        } else if (highestSim > MAX_SIMILARITY) {
            const err = document.createElement("div");
            err.className = "mt-4 p-4 bg-amber-900/40 border border-amber-500 rounded text-amber-200 text-sm";
            err.innerHTML = `<strong>â›” Submission Blocked: Duplicate</strong><p class="mt-1 text-xs opacity-80">This idea matches an existing entry too closely (>95%).</p>`;
            similarResults.appendChild(err);
            submitButton.classList.add("hidden");
        } else {
            // Success: Allow submission & ENABLE BUTTON
            submitButton.classList.remove("hidden");
            submitButton.disabled = false; // <--- CRITICAL FIX
        }
    }

    async function handleSubmit() {
        console.log("Submit Clicked"); 
        const text = ideaText.value.trim();
        if (!text) return;
        
        // 1. Disable button immediately
        submitButton.disabled = true;
        document.getElementById("submitSpinner").classList.remove("hidden");

        try {
            const res = await fetch(SUBMIT_URL, {
                method: "POST", 
                headers: { "Content-Type": "application/json" }, 
                body: JSON.stringify({ text })
            });
            const data = await res.json();
            displayResult(data);
            
            // 2. Hide button on success so they can't spam it
            submitButton.classList.add("hidden");

        } catch (err) {
            console.error("Submit Error:", err);
            document.getElementById("resultOutput").innerHTML = `<p class="text-red-400">Error: ${err.message}</p>`;
            resultContainer.classList.remove("hidden");
            
            // 3. Re-enable only if it crashed (network error)
            submitButton.disabled = false; 
        } finally {
            document.getElementById("submitSpinner").classList.add("hidden");
        }
    }

    function displayResult(data) {
        const fr = data.frontend_response || data;
        const out = document.getElementById("resultOutput");
        
        // Brighten results
        resultContainer.classList.remove("opacity-50");

        // Handle Soft Rejection
        if (fr.verdict === "REJECTED") {
            out.innerHTML = `
                <div class="p-5 bg-red-900/40 border border-red-500 rounded-lg shadow-lg">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="p-2 bg-red-500/20 rounded-full text-red-400">â›”</div>
                        <h3 class="text-xl font-bold text-red-400">Idea Not Accepted</h3>
                    </div>
                    <p class="text-gray-300 mb-4">${fr.reason || "Idea did not meet quality standards."}</p>
                    <div class="text-sm bg-gray-800/50 p-3 rounded border border-gray-700">
                        <span class="text-gray-400">Ambiguity Score:</span>
                        <span class="font-mono font-bold text-red-300 ml-2">${fr.score}</span>
                    </div>
                </div>`;
            resultContainer.classList.remove("hidden");
            return;
        }

        // Handle Hard Errors
        if (fr.error) {
            out.innerHTML = `<div class="p-4 bg-red-900/50 border border-red-500 rounded"><h3 class="font-bold text-red-400">Submission Failed</h3><p class="text-sm text-gray-300">${fr.error.error_details || fr.error}</p></div>`;
            resultContainer.classList.remove("hidden");
            return;
        }

        // Handle Success
        const ai = fr.components?.ai_analysis || {};
        const proofId = fr.proof_id || "N/A";
        
        let html = `
            <div class="bg-gray-800/60 rounded-lg p-5 border border-green-500/30 shadow">
                <h2 class="text-xl text-green-400 font-bold mb-1">Idea Registered Successfully!</h2>
                <p class="text-xs text-gray-500 font-mono mb-4">ID: ${proofId}</p>
                
                <div class="bg-gray-900/40 p-4 rounded border border-gray-700 mb-4">
                    <h3 class="text-lg font-semibold text-indigo-300 mb-2">Analysis</h3>
                    <p class="text-gray-300 text-sm leading-relaxed">${ai.summary || "No summary available."}</p>
                </div>
        `;

        if (ai.interpretations && ai.interpretations.length > 0) {
             html += `
                <div>
                    <button onclick="window.toggleCollapse()" 
                        class="flex items-center justify-between w-full bg-gray-700/40 p-3 rounded-lg 
                               border border-gray-600 hover:bg-gray-700 transition text-sm">
                        <span class="font-semibold text-indigo-300">Possible Interpretations</span>
                        <span id="chevron" class="transition-transform text-gray-300 text-xs">&#9656;</span>
                    </button>

                    <div id="collapsible" 
                         class="collapsible-content bg-gray-800/40 rounded-lg border border-gray-700 mt-2 px-4">
                        <ul class="list-disc list-inside space-y-2 py-3 text-sm text-gray-300">
                            ${ai.interpretations.map(i => 
                                `<li><strong class="text-indigo-300">${i.theme}:</strong> ${i.interpretation}</li>`
                            ).join('')}
                        </ul>
                    </div>
                </div>
             `;
        }

        html += "</div>";
        out.innerHTML = html;
        resultContainer.classList.remove("hidden");
    }

    window.toggleCollapse = function() {
        const content = document.getElementById("collapsible");
        const chevron = document.getElementById("chevron");
        if(content && chevron) {
            content.classList.toggle("collapsible-open");
            chevron.classList.toggle("rotate-90");
        }
    }
});
</script>
</body>
</html>