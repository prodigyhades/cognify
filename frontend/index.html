<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cognify - Level 1</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Simple loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Rating stars */
        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: center;
        }
        .star-rating input { display: none; }
        .star-rating label {
            font-size: 2.5rem;
            color: #4a5568;
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-rating input:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #fbbf24;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-6">

    <div class="max-w-2xl w-full bg-gray-800 p-8 rounded-lg shadow-xl">
        <h1 class="text-3xl font-bold text-center mb-2">Cognify ðŸ§ </h1>
        <p class="text-center text-gray-400 mb-6">Level 1: Semantic & Crowd Analysis</p>

        <!-- INPUT FORM -->
        <form id="ideaForm" class="space-y-4">
            <label class="block text-sm mb-1">Your Idea (Max 280 chars):</label>

            <textarea id="ideaText" rows="4" maxlength="280"
                class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md text-gray-100 focus:ring-indigo-500"
                placeholder="Example: A fork that vibrates if you eat too fast"></textarea>

            <div class="text-right text-sm text-gray-400">
                <span id="charCount">0</span> / 280
            </div>

            <button type="submit" id="submitButton"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold p-3 rounded-md flex items-center justify-center">
                <span id="buttonText">Analyze Originality</span>
                <div id="loadingSpinner" class="spinner hidden ml-2"></div>
            </button>
        </form>

        <!-- OUTPUT -->
        <div id="resultContainer" class="hidden mt-6">
            <div id="resultOutput"></div>
        </div>
    </div>

    <script>
        /* CONFIG - update these for deployment */
        const ANALYZE_WEBHOOK_URL = "http://localhost:5678/webhook/cognify-v0";
        const RATING_WEBHOOK_URL  = "http://localhost:5678/webhook/cognify-rate";

        /* STATE */
        let currentProofId = null;

        /* ELEMENTS */
        const ideaText = document.getElementById("ideaText");
        const charCount = document.getElementById("charCount");
        const resultContainer = document.getElementById("resultContainer");
        const resultOutput = document.getElementById("resultOutput");
        const submitButton = document.getElementById("submitButton");
        const buttonText = document.getElementById("buttonText");
        const loadingSpinner = document.getElementById("loadingSpinner");

        /* Character counter */
        ideaText.addEventListener("input", () => {
            charCount.textContent = ideaText.value.length;
        });

        /* FORM SUBMIT */
        document.getElementById("ideaForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!ideaText.value.trim()) return;

            setLoading(true);

            try {
                const response = await fetch(ANALYZE_WEBHOOK_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text: ideaText.value })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                console.log("RAW RESPONSE:", data);

                displayResult(data);

            } catch (err) {
                console.error(err);
                displayResult({ error: "Server error: " + err.message });

            } finally {
                setLoading(false);
            }
        });


        /* RATING SUBMISSION */
        async function submitRating(rating) {
            if (!currentProofId) return alert("No proof ID available.");

            try {
                await fetch(RATING_WEBHOOK_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ idea_id: currentProofId, rating })
                });

                document.getElementById("ratingSection").innerHTML =
                    `<p class="text-green-400 font-bold text-center">Thanks for rating!</p>`;

            } catch (err) {
                alert("Rating failed.");
            }
        }

        /* LOADING HANDLER */
        function setLoading(isLoading) {
            buttonText.textContent = isLoading ? "Analyzing..." : "Analyze Originality";
            submitButton.disabled = isLoading;
            loadingSpinner.classList.toggle("hidden", !isLoading);
            if (isLoading) resultContainer.classList.add("hidden");
        }

        /* DISPLAY RESULT */
        function displayResult(data) {
            resultOutput.innerHTML = "";

            // normalize response shape
            const fr = data.frontend_response || data;

            if (!fr || typeof fr !== "object") {
                resultOutput.innerHTML = `<p class="text-red-400">Invalid server response.</p>`;
                resultContainer.classList.remove("hidden");
                return;
            }

            if (fr.error) {
                resultOutput.innerHTML = `<p class="text-red-400">${fr.error}</p>`;
                resultContainer.classList.remove("hidden");
                return;
            }

            // Save proof ID for rating
            currentProofId = fr.proof_id;

            const ai = fr.components?.ai_analysis || {};
            const interpretations = ai.interpretations || [];

            let html = `
                <h2 class="text-2xl font-bold text-green-400">Verdict: ${fr.verdict}</h2>
                <p class="text-xs text-gray-400 mb-3">Proof ID: ${fr.proof_id}</p>

                <div class="border-t border-gray-700 pt-4 mt-4">
                    <h3 class="text-xl font-semibold mb-2">Cognitive Analysis</h3>

                    <p><strong>Summary:</strong> ${ai.summary || "(no summary)"}</p>

                    <div class="mt-4">
                        <label class="text-sm">Ambiguity Index</label>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div class="bg-indigo-500 h-2 rounded-full"
                                 style="width:${(ai.ambiguity_index || 0) * 100}%"></div>
                        </div>
                        <p class="text-xs text-gray-400">${ai.ambiguity_index ?? "(none)"}</p>
                    </div>

                    <h4 class="text-md font-semibold mt-4 mb-1">Possible Interpretations:</h4>
                    <ul class="list-disc list-inside space-y-1">
            `;

            interpretations.forEach(i => {
                html += `<li><span class="text-indigo-300">${i.theme}:</span> ${i.interpretation}</li>`;
            });

            html += `
                    </ul>
                </div>

                <div id="ratingSection" class="border-t border-gray-700 mt-6 pt-4">
                    <h3 class="text-lg font-semibold text-center mb-1">Rate this Idea</h3>

                    <div class="star-rating">
                        <input id="star5" type="radio" name="rating" onclick="submitRating(5)">
                        <label for="star5">â˜…</label>

                        <input id="star4" type="radio" name="rating" onclick="submitRating(4)">
                        <label for="star4">â˜…</label>

                        <input id="star3" type="radio" name="rating" onclick="submitRating(3)">
                        <label for="star3">â˜…</label>

                        <input id="star2" type="radio" name="rating" onclick="submitRating(2)">
                        <label for="star2">â˜…</label>

                        <input id="star1" type="radio" name="rating" onclick="submitRating(1)">
                        <label for="star1">â˜…</label>
                    </div>
                </div>
            `;

            resultOutput.innerHTML = html;
            resultContainer.classList.remove("hidden");
        }
    </script>
</body>
</html>
